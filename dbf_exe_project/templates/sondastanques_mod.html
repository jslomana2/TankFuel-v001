<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Tanques ‚Äì Vista avanzada (PROCONSI Smart)</title>
<link rel="stylesheet" href="{{ url_for('static', filename='sondastanques_mod.css') }}">
<style>
/* Estilos adicionales para autorefresco */
.h-sub{
  display:flex;
  align-items:center;
  gap:12px;
  padding:8px 16px;
  border-top:1px solid #e6e9ee;
  background:#fff;
  color:#0b1220;
  justify-content: space-between;
}
.chk-all{
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-size:13px;
}
.chk-all input[type="checkbox"]{
  width:16px;
  height:16px;
  accent-color:#0b1220;
}
.auto-refresh-indicator {
  font-size: 13px;
  color: #666;
  display: flex;
  align-items: center;
}
.auto-refresh-indicator #autoRefreshStatus {
  padding: 4px 8px;
  border-radius: 4px;
  background: rgba(0,0,0,0.05);
  font-weight: 500;
}

/* Estilos para modo "Ver todos" con layout horizontal */
.almacenSection {
  margin: 20px 16px 30px 16px; 
  padding: 0; 
  background: transparent; 
  border: none; 
  border-radius: 0;
}

.almacenTitle {
  font-size: 18px; 
  font-weight: 700; 
  margin: 0 0 16px 0; 
  color: #e7eef6;
  background: linear-gradient(135deg, #0e1520, #1a2332);
  padding: 12px 16px;
  border-radius: 12px;
  border-left: 4px solid #2aa8ff;
}

.tanks-grid {
  display: grid !important;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)) !important;
  gap: 16px !important;
  padding: 0 !important;
}

/* Asegurar que el grid principal funcione para ambos modos */
#grid {
  padding: 0;
}

/* Cuando NO est√° en modo "ver todos", usar el grid normal */
#grid:not(.show-all-mode) {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 16px;
  padding: 14px 16px;
}

/* Cuando S√ç est√° en modo "ver todos", usar display block */
#grid.show-all-mode {
  display: block !important;
}
</style>
</head>
<body>
<div class="wrap">
<header>
<div class="h-inner">
<a class="brand" href="https://www.proconsi.com" rel="noopener" target="_blank">
<img alt="Proconsi" src="{{ url_for('static', filename='proconsi.svg') }}" onerror="this.style.display='none'; this.parentNode.innerHTML='<strong style=&quot;background:#0e1520;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px;&quot;>PROCONSI</strong>'"/>
</a>
<div class="title">Tanques ¬∑ Vista avanzada</div>
<div class="pill" id="summary">Cargando‚Ä¶</div>
<div class="spacer"></div>
<div class="ctrls">
<button id="alarmsBtn" title="Ir a alarmas">üîî Alarmas</button>
<button id="refreshBtn" data-throttle="1" title="Refrescar datos">‚ü≥ Refrescar</button>
<button id="prevBtn" title="Almac√©n anterior">‚Üê</button>
<select id="almacenSel"></select>
<button id="nextBtn" title="Almac√©n siguiente">‚Üí</button>
</div>
</div>
<div class="h-sub">
<label class="chk-all">
<input id="allToggle" type="checkbox"/>
<span>Ver todos los almacenes</span>
</label>
<div class="auto-refresh-indicator">
<span id="autoRefreshStatus">üü¢ Autorefresco: Activo</span>
</div>
</div>
</header>
<div class="grid" id="grid"></div>
<div aria-label="Totales por producto" id="totales"></div>
<div hidden="" id="histPanel">
<div id="histHeader">
<div class="title" id="histTitle">Hist√≥rico</div>
<div class="pill" id="histInfo">‚Äî</div>
<div id="histBtns">
<select id="groupSel" title="Agrupar para el gr√°fico">
<option value="hours">Horas</option>
<option selected="" value="days">D√≠as</option>
</select>
<button id="exportBtn" title="Exportar a Excel (CSV)">‚¨á Excel</button>
<button id="pdfBtn" title="Exportar a PDF">‚¨á PDF</button>
</div>
</div>
<div id="histFilters">
<label>Desde <input id="fromDate" type="date"/></label>
<label>Hasta <input id="toDate" type="date"/></label>
<button id="applyFilter">Aplicar</button>
<button id="quick7">√öltimos 7 d√≠as</button>
<button id="quick30">√öltimos 30 d√≠as</button>
<span class="pill" id="rowsCount">0 filas</span>
</div>
<canvas id="histChart"></canvas>
<table class="hist" id="histTable">
<thead><tr><th>Fecha</th><th>Medido (L)</th><th>Libro (L)</th><th>Dif. (L)</th></tr></thead>
<tbody></tbody>
</table>
</div>
<footer>
<div class="legend">
<span class="chip"><span class="dot" style="background:var(--bad)"></span> Bajo</span>
<span class="chip"><span class="dot" style="background:var(--warn)"></span> Medio</span>
<span class="chip"><span class="dot" style="background:var(--ok)"></span> Alto</span>
<span class="chip"><span class="dot" style="background:var(--water)"></span> Agua</span>
</div>
<div id="footerInfo"></div>
</footer>
</div>

<script>
(function(){
  // Control para mostrar todos los almacenes por secciones
  var cb, lastRaw = null, setDataOrig = null, allAlmacenes = [];
  function qs(id){ return document.getElementById(id); }
  function setControlsEnabled(flag){
    var sel = qs("almacenSel"), prev = qs("prevBtn"), next = qs("nextBtn");
    if(sel) sel.disabled = !flag;
    if(prev) prev.disabled = !flag;
    if(next) next.disabled = !flag;
  }
  
  function applyMode(){
    if(!setDataOrig) return;
    var all = !!(cb && cb.checked);
    window.__showAllMode = all;
    
    if(all && allAlmacenes.length > 0){
      setControlsEnabled(false);
      setDataOrig({ almacenes: allAlmacenes, activoId: null });
    }else if(!all && lastRaw){
      setControlsEnabled(true);
      setDataOrig(lastRaw);
    }
  }
  
  function hookSetDataSoon(){
    var tries = 0;
    var iv = setInterval(function(){
      tries++;
      if(typeof window.setData === "function"){
        if(!setDataOrig){
          setDataOrig = window.setData;
          window.setData = function(input){
            lastRaw = input;
            // Guardar todos los almacenes para el modo "Ver todos"
            if(input && input.almacenes){
              allAlmacenes = input.almacenes.slice();
            }
            // Aplicar seg√∫n modo actual
            applyMode();
          };
        }
        clearInterval(iv);
      }else if(tries>50){ // ~5s
        clearInterval(iv);
      }
    }, 100);
  }
  
  function init(){
    cb = qs("allToggle");
    window.__showAllMode = false;
    hookSetDataSoon();
    if(cb){
      cb.checked = false;
      cb.addEventListener("change", applyMode);
    }
  }
  
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", init);
  }else{
    init();
  }
})();
</script>

<script>window.__vfp_integration__=true;</script>
<script src="{{ url_for('static', filename='sondastanques_mod.js') }}"></script>

<script>
// INICIALIZACI√ìN CORREGIDA
(function(){
  var allAlmacenesData = []; // Variable para guardar todos los almacenes
  
  async function fetchJSON(url) {
    console.log('üåê Fetching:', url);
    try {
      const response = await fetch(url);
      if (!response.ok) {
        console.error('‚ùå HTTP Error:', response.status, response.statusText);
        return null;
      }
      const data = await response.json();
      console.log('‚úÖ Data received:', data);
      return data;
    } catch (error) {
      console.error('‚ùå Fetch error:', error);
      return null;
    }
  }

  window.__sondasUI = {
    async init() {
      try {
        console.log('üöÄ DOM listo, iniciando carga...');
        console.log('üîÑ Iniciando carga de almacenes...');
        
        // Obtener almacenes directamente del API
        const almacenes = await fetchJSON('/api/almacenes');
        
        if (!almacenes || !Array.isArray(almacenes)) {
          console.error('‚ùå No se pudieron cargar almacenes o formato incorrecto');
          return;
        }
        
        console.log('üì¶ Almacenes encontrados:', almacenes.length);
        
        if (almacenes.length === 0) {
          console.warn('‚ö†Ô∏è No hay almacenes disponibles');
          return;
        }
        
        // Procesar almacenes para el formato esperado
        const processedAlmacenes = almacenes.map(alm => {
          // Convertir estructura del API al formato esperado por el frontend
          const processed = {
            id: alm.codigo,
            nombre: `${alm.codigo} ‚Äì ${alm.poblacion}`,
            tanques: (alm.tanques || []).map(tank => ({
              almacen: tank.almacen,
              nombre: tank.nombre || `TANQUE ${tank.codigo}`,
              producto: tank.articulo_nombre || `ART-${tank.articulo}`,
              color: tank.color || tank.colorProducto || tank.colorRGB || '#2aa8ff', // USAR COLOR REAL
              colorProducto: tank.color || tank.colorProducto || tank.colorRGB || '#2aa8ff',
              colorRGB: tank.color || tank.colorProducto || tank.colorRGB || '#2aa8ff',
              capacidad: tank.capacidad,
              volumen: tank.volumen,
              temperatura: tank.temperatura,
              fecha_ultimo_calado: tank.fecha_ultimo_calado,
              alturaAgua: 0,
              status: 'ok',
              spark: [tank.nivel || tank.volumen || 0]
            }))
          };
          
          console.log(`‚úÖ Procesado almac√©n: ${processed.id} con ${processed.tanques.length} tanques`);
          if (processed.tanques.length > 0) {
            console.log(`  Primer tanque: ${processed.tanques[0].nombre}, Color: ${processed.tanques[0].color}`);
          }
          return processed;
        });
        
        console.log('üéØ Total almacenes procesados:', processedAlmacenes.length);
        
        // Guardar todos los almacenes para el modo "Ver todos"
        allAlmacenesData = processedAlmacenes;
        
        // Establecer datos en la UI
        if (window.setData && typeof window.setData === 'function') {
          console.log('üìä Estableciendo datos en UI...');
          window.setData({
            almacenes: processedAlmacenes,
            activoId: processedAlmacenes[0]?.id
          });
          console.log('‚ú® Carga completada exitosamente');
        } else {
          console.error('‚ùå window.setData no disponible');
        }
        
      } catch (error) {
        console.error('üí• Error en inicializaci√≥n:', error);
      }
    },

    async change(cod) {
      console.log('üîÑ Cambiando a almac√©n:', cod);
      // El cambio se maneja autom√°ticamente por el sistema existente
    },

    async refreshData() {
      try {
        console.log('üîÑ Iniciando refresco de datos...');
        
        // Recargar datos
        await this.init();
        
        console.log('‚úÖ Refresco completado');
        
        // Actualizar indicador
        const statusEl = document.getElementById('autoRefreshStatus');
        if (statusEl) {
          statusEl.innerHTML = 'üü¢ Actualizado: ' + new Date().toLocaleTimeString();
        }
        
      } catch (error) {
        console.error('‚ùå Error en refreshData:', error);
        
        const statusEl = document.getElementById('autoRefreshStatus');
        if (statusEl) {
          statusEl.innerHTML = 'üî¥ Error al actualizar';
        }
      }
    },

    // FUNCI√ìN PARA MODO "VER TODOS"
    showAllMode(enabled) {
      console.log('üéØ Modo "Ver todos":', enabled ? 'ACTIVADO' : 'DESACTIVADO');
      
      if (enabled && allAlmacenesData.length > 0) {
        // Mostrar todos los almacenes
        window.__showAllMode = true;
        if (window.setData) {
          window.setData({
            almacenes: allAlmacenesData,
            activoId: null // null significa "todos"
          });
        }
      } else {
        // Volver a modo normal
        window.__showAllMode = false;
        if (window.setData && allAlmacenesData.length > 0) {
          window.setData({
            almacenes: allAlmacenesData,
            activoId: allAlmacenesData[0]?.id
          });
        }
      }
    }
  };
  
  // Inicializar cuando el DOM est√© listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ DOM ready, initializing...');
      window.__sondasUI.init();
      
      // CONECTAR EL CHECKBOX "VER TODOS"
      setTimeout(() => {
        const checkbox = document.getElementById('allToggle');
        if (checkbox) {
          checkbox.addEventListener('change', (e) => {
            window.__sondasUI.showAllMode(e.target.checked);
          });
          console.log('‚úÖ Checkbox "Ver todos" conectado');
        }
      }, 1000);
    });
  } else {
    console.log('üöÄ DOM already ready, initializing...');
    window.__sondasUI.init();
    
    // CONECTAR EL CHECKBOX "VER TODOS"
    setTimeout(() => {
      const checkbox = document.getElementById('allToggle');
      if (checkbox) {
        checkbox.addEventListener('change', (e) => {
          window.__sondasUI.showAllMode(e.target.checked);
        });
        console.log('‚úÖ Checkbox "Ver todos" conectado');
      }
    }, 1000);
  }
})();
</script>

<script>
(function(){
  var btn=document.getElementById('refreshBtn');
  if(!btn)return;
  var cooling=false;
  btn.addEventListener('click',function(e){
    if(cooling){
      e.stopImmediatePropagation();
      e.preventDefault();
      return;
    }
    cooling=true;
    setTimeout(function(){cooling=false;},600);
  },true);
})();
</script>

</body>
</html>
