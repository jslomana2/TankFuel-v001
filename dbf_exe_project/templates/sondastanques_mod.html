<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Tanques ‚Äì Vista avanzada (PROCONSI Smart)</title>
<link rel="stylesheet" href="{{ url_for('static', filename='sondastanques_mod.css') }}">
<style>
/* Estilos adicionales para autorefresco */
.h-sub{
  display:flex;
  align-items:center;
  gap:12px;
  padding:8px 16px;
  border-top:1px solid #e6e9ee;
  background:#fff;
  color:#0b1220;
  justify-content: space-between;
}
.chk-all{
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-size:13px;
}
.chk-all input[type="checkbox"]{
  width:16px;
  height:16px;
  accent-color:#0b1220;
}
.auto-refresh-indicator {
  font-size: 13px;
  color: #666;
  display: flex;
  align-items: center;
}
.auto-refresh-indicator #autoRefreshStatus {
  padding: 2px 6px;
  border-radius: 4px;
  background: rgba(0,0,0,0.05);
}
</style>
</head>
<body>
<div class="wrap">
<header>
<div class="h-inner">
<a class="brand" href="https://www.proconsi.com" rel="noopener" target="_blank">
<img alt="Proconsi" onerror="this.style.display='none'; this.parentNode.insertAdjacentHTML('beforeend','&lt;strong style=&quot;background:#0e1520;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px;&quot;&gt;PROCONSI&lt;/strong&gt;')" src="{{ url_for('static', filename='proconsi.svg') }}"/>
</a>
<div class="title">Tanques ¬∑ Vista avanzada</div>
<div class="pill" id="summary">Cargando‚Ä¶</div>
<div class="spacer"></div>
<div class="ctrls">
<button id="alarmsBtn" title="Ir a alarmas">üîî Alarmas</button>
<button id="refreshBtn" data-throttle="1" title="Refrescar datos">‚ü≥ Refrescar</button>
<button id="prevBtn" title="Almac√©n anterior">‚Üê</button>
<select id="almacenSel"></select>
<button id="nextBtn" title="Almac√©n siguiente">‚Üí</button>
</div>
</div>
<div class="h-sub">
<label class="chk-all">
<input id="allToggle" type="checkbox"/>
<span>Ver todos los almacenes</span>
</label>
<div class="auto-refresh-indicator">
<span id="autoRefreshStatus">üü¢ Autorefresco: Activo</span>
</div>
</div>
</header>
<div class="grid" id="grid"></div>
<div aria-label="Totales por producto" id="totales"></div>
<div hidden="" id="histPanel">
<div id="histHeader">
<div class="title" id="histTitle">Hist√≥rico</div>
<div class="pill" id="histInfo">‚Äî</div>
<div id="histBtns">
<select id="groupSel" title="Agrupar para el gr√°fico">
<option value="hours">Horas</option>
<option selected="" value="days">D√≠as</option>
</select>
<button id="exportBtn" title="Exportar a Excel (CSV)">‚¨á Excel</button>
<button id="pdfBtn" title="Exportar a PDF">‚¨á PDF</button>
</div>
</div>
<div id="histFilters">
<label>Desde <input id="fromDate" type="date"/></label>
<label>Hasta <input id="toDate" type="date"/></label>
<button id="applyFilter">Aplicar</button>
<button id="quick7">√öltimos 7 d√≠as</button>
<button id="quick30">√öltimos 30 d√≠as</button>
<span class="pill" id="rowsCount">0 filas</span>
</div>
<canvas id="histChart"></canvas>
<table class="hist" id="histTable">
<thead><tr><th>Fecha</th><th>Medido (L)</th><th>Libro (L)</th><th>Dif. (L)</th></tr></thead>
<tbody></tbody>
</table>
</div>
<footer>
<div class="legend">
<span class="chip"><span class="dot" style="background:var(--bad)"></span> Bajo</span>
<span class="chip"><span class="dot" style="background:var(--warn)"></span> Medio</span>
<span class="chip"><span class="dot" style="background:var(--ok)"></span> Alto</span>
<span class="chip"><span class="dot" style="background:var(--water)"></span> Agua</span>
</div>
<div id="footerInfo"></div>
</footer>
</div>

<script>
(function(){
  // Control para mostrar todos los almacenes por secciones
  var cb, lastRaw = null, setDataOrig = null, allAlmacenes = [];
  function qs(id){ return document.getElementById(id); }
  function setControlsEnabled(flag){
    var sel = qs("almacenSel"), prev = qs("prevBtn"), next = qs("nextBtn");
    if(sel) sel.disabled = !flag;
    if(prev) prev.disabled = !flag;
    if(next) next.disabled = !flag;
  }
  
  function applyMode(){
    if(!setDataOrig) return;
    var all = !!(cb && cb.checked);
    window.__showAllMode = all;
    
    if(all && allAlmacenes.length > 0){
      setControlsEnabled(false);
      setDataOrig({ almacenes: allAlmacenes, activoId: null });
    }else if(!all && lastRaw){
      setControlsEnabled(true);
      setDataOrig(lastRaw);
    }
  }
  
  function hookSetDataSoon(){
    var tries = 0;
    var iv = setInterval(function(){
      tries++;
      if(typeof window.setData === "function"){
        if(!setDataOrig){
          setDataOrig = window.setData;
          window.setData = function(input){
            lastRaw = input;
            // Guardar todos los almacenes para el modo "Ver todos"
            if(input && input.almacenes){
              allAlmacenes = input.almacenes.slice();
            }
            // Aplicar seg√∫n modo actual
            applyMode();
          };
        }
        clearInterval(iv);
      }else if(tries>50){ // ~5s
        clearInterval(iv);
      }
    }, 100);
  }
  
  function init(){
    cb = qs("allToggle");
    window.__showAllMode = false;
    hookSetDataSoon();
    if(cb){
      cb.checked = false;
      cb.addEventListener("change", applyMode);
    }
  }
  
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", init);
  }else{
    init();
  }
})();
</script>

<script>window.__vfp_integration__=true;</script>
<script src="{{ url_for('static', filename='sondastanques_mod.js') }}"></script>

<script>
(function(){
  const cache = new Map();
  let allAlmacenes = [];
  
  async function j(u){
    try {
      const r = await fetch(u);
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    } catch(e) {
      console.error('Error en petici√≥n:', u, e);
      return {almacenes: [], tanques: []};
    }
  }
  
  async function getAlmacenes(){
    const a = await j('/api/almacenes?n=200');
    return a.almacenes || [];
  }
  
  async function getTanques(cod){
    if(cache.has(cod)) return cache.get(cod);
    
    const d = await j('/api/tanques_norm?almacen=' + encodeURIComponent(cod) + '&n=5');
    const tanques = (d.tanques || []).map(t => ({
      almacen: t.almacen, 
      nombre: t.tanque_nombre, 
      producto: t.producto_nombre || t.producto,
      color: t.producto_color, 
      colorProducto: t.producto_color, 
      colorRGB: t.producto_color,
      capacidad: t.capacidad, 
      volumen: t.volumen, 
      temperatura: t.temperatura,
      fecha_ultimo_calado: t.fecha_ultimo_calado, // ¬°NUEVO CAMPO!
      alturaAgua: 0, 
      status: 'ok', 
      spark: []
    }));
    
    // Obtener nombre completo del almac√©n (c√≥digo + poblaci√≥n)
    const almacenInfo = (d.almacenes || []).find(a => a.codigo === cod);
    const nombreCompleto = almacenInfo ? `${cod} ‚Äì ${almacenInfo.nombre}` : cod;
    
    const store = { 
      id: d.almacen || cod, 
      nombre: nombreCompleto,
      tanques 
    };
    
    cache.set(cod, store);
    return store;
  }
  
  window.__sondasUI = {
    async init(){
      try {
        console.log('üîÑ Iniciando carga de almacenes...');
        const alms = await getAlmacenes();
        console.log('üì¶ Almacenes encontrados:', alms.length);
        
        if(!alms.length){ 
          if(window.setData) window.setData({ almacenes:[], activoId:null }); 
          return; 
        }
        
        // Cargar TODOS los almacenes de forma secuencial
        const allStores = [];
        for(let i = 0; i < alms.length; i++){
          const a = alms[i];
          try{ 
            console.log(`üìã Cargando almac√©n ${i+1}/${alms.length}: ${a.codigo}`);
            const store = await getTanques(a.codigo);
            if(store.tanques && store.tanques.length > 0){
              allStores.push(store);
              console.log(`‚úÖ ${a.codigo}: ${store.tanques.length} tanques`);
            } else {
              console.log(`‚ö†Ô∏è ${a.codigo}: sin tanques`);
            }
          }catch(e){ 
            console.error('‚ùå Error cargando almac√©n', a.codigo, e); 
          }
        }
        
        console.log(`üéØ Total almacenes con tanques: ${allStores.length}`);
        allAlmacenes = allStores;
        
        // Establecer datos con todos los almacenes cargados
        const first = alms[0].codigo;
        if(window.setData) {
          console.log('üìä Estableciendo datos en UI...');
          window.setData({ almacenes: allStores, activoId: first });
        }
        
        console.log('‚ú® Carga completada exitosamente');
        
      } catch(e) {
        console.error('üí• Error en inicializaci√≥n:', e);
      }
    },
    
    async change(cod){
      if(!cache.has(cod)) await getTanques(cod);
      if(window.setData) {
        window.setData({ almacenes: allAlmacenes, activoId: cod });
      }
    },
    
    // ¬°NUEVA FUNCI√ìN PARA AUTOREFRESCO!
    async refreshData(){
      try {
        console.log('üîÑ Iniciando refresco de datos...');
        
        // Limpiar cache para forzar recarga
        cache.clear();
        
        // Recargar todos los almacenes
        const alms = await getAlmacenes();
        if(!alms.length) return;
        
        const allStores = [];
        for(const a of alms){
          try{ 
            const store = await getTanques(a.codigo);
            if(store.tanques && store.tanques.length > 0){
              allStores.push(store);
            }
          }catch(e){ 
            console.error('‚ùå Error recargando almac√©n', a.codigo, e); 
          }
        }
        
        allAlmacenes = allStores;
        
        // Mantener almac√©n activo actual
        const currentActive = window.setData && window.setData._lastActivoId;
        
        if(window.setData) {
          window.setData({ almacenes: allStores, activoId: currentActive || alms[0].codigo });
        }
        
        console.log('‚úÖ Refresco completado:', allStores.length, 'almacenes');
        
        // Actualizar indicador de estado
        const statusEl = document.getElementById('autoRefreshStatus');
        if(statusEl) {
          statusEl.innerHTML = 'üü¢ Actualizado: ' + new Date().toLocaleTimeString();
        }
        
      } catch(e) {
        console.error('‚ùå Error en refreshData:', e);
        
        const statusEl = document.getElementById('autoRefreshStatus');
        if(statusEl) {
          statusEl.innerHTML = 'üî¥ Error al actualizar';
        }
      }
    }
  };
  
  document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ DOM listo, iniciando carga...');
    window.__sondasUI.init();
  });
})();
</script>

<script>
(function(){
  var btn=document.getElementById('refreshBtn');
  if(!btn)return;
  var cooling=false;
  btn.addEventListener('click',function(e){
    if(cooling){
      e.stopImmediatePropagation();
      e.preventDefault();
      return;
    }
    cooling=true;
    setTimeout(function(){cooling=false;},600);
  },true);
})();
</script>

</body>
</html>
