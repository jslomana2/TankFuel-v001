<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compat Tanques</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='sondastanques_mod.css') }}">
  <style>body{background:transparent}</style>
</head>
<body>
  <main id="grid" style="padding:10px">Cargando…</main>
  <script>
  (async()=>{
    const grid = document.getElementById('grid');
    const show = (m)=> grid.innerHTML = '<div style="padding:10px;color:#9bb0c8">'+m+'</div>';
    try{
      const ra = await fetch('/api/almacenes');
      const ja = await ra.json();
      let alm = (ja.ok && ja.data && ja.data.length) ? ja.data[0].codigo : null;
      const url = alm ? '/api/tanques_norm?almacen='+encodeURIComponent(alm)+'&n=5' : '/api/tanques_norm?n=5';
      const rt = await fetch(url);
      const jt = await rt.json();
      if (!jt.ok) { show('Error: '+(jt.error||'sin datos')); return; }
      if (!jt.data.length){ show('Sin tanques.'); return; }
      grid.innerHTML = jt.data.map(t => `
        <article class="card" style="margin:10px">
          <h3 style="display:flex;justify-content:space-between;align-items:center">
            <span>${t.nombre}</span>
            <span class="badge" style="background:${t.color}22;border:1px solid ${t.color}88;padding:2px 8px;border-radius:999px">${t.producto||''}</span>
          </h3>
          <div class="meta">Alm: ${t.almacen} · Cap: ${t.capacidad??'-'} L · Temp: ${t.temperatura??'-'} ºC</div>
          <div class="label">Nivel: <strong>${(t.volumen??0).toLocaleString('es-ES')}</strong> L ${t.litros15!=null? ' · 15º: <strong>'+t.litros15.toLocaleString('es-ES')+'</strong> L':''}</div>
          <div class="bar"><div class="fill" style="width:${t.porcentaje? t.porcentaje.toFixed(1):0}% ; background:${t.color}"></div></div>
        </article>
      `).join('');
    }catch(e){ show('Error al cargar: '+(e.message||e)); }
  })();
  </script>
</body>
</html>
